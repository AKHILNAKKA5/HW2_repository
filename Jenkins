pipeline {
    agent any
    
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('docker-creds') // Docker Hub credentials ID in Jenkins
        KUBECONFIG = credentials('Kubeconfig')         // Kubeconfig credentials ID in Jenkins
        dockerImage = ''
    }

    stages {
        stage('Build the image') {
            steps {
                script {
                    checkout scm
                    // Build the Docker image and tag it with the build number
                    sh 'docker build -t anakka5/hw2:${BUILD_NUMBER} .'  
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    // Login to Docker Hub using credentials stored in Jenkins
                    sh "docker login -u $DOCKER_HUB_CREDENTIALS_USR -p $DOCKER_HUB_CREDENTIALS_PSW"
                    // Push the image to Docker Hub
                    sh 'docker push anakka5/hw2:${BUILD_NUMBER}'                  }
            }
        }

        stage('Update Deployment File') {
            steps {
                script {
                    // Directly modify the deployment.yaml file to set the correct image tag
                    def tag = currentBuild.number
                    sh "sed -i 's|image: anakka5/hw2:.*|image: anakka5/hw2:${tag}|' deployment.yaml"
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'kube-config-cred', variable: 'KUBECONFIG')]) {
                        // Apply the updated deployment and service configurations to Kubernetes
                        sh 'kubectl --kubeconfig=$KUBECONFIG apply -f deployment.yaml'
                        sh 'kubectl --kubeconfig=$KUBECONFIG apply -f service.yaml'
                    }
                }
            }
        }
    }
}
